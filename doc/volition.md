设计**主动行为系统 (Volition System)** 的核心在于把握**“度”**。
*   太活跃 = 像个刷屏的广告机，会被踢出群。
*   太沉寂 = 像个只会回复的客服，没有存在感。

我们需要设计一个**基于“冲动值 (Impulse)”的决策引擎**。它不应该是一个简单的定时器，而是一个模拟生物**“想说话的欲望”**的动态系统。

以下是详细设计方案：

---

### 一、 核心逻辑：冲动值计算公式 (The Impulse Engine)

我们需要一个实时变化的变量：**`Current_Impulse` (当前冲动值)**，范围 0~100。
每当群里有新消息，或者时间流逝，这个值都会变化。

$$Impulse = (基本欲望 + 外部刺激 + 情绪加成) - (疲劳值)$$

1.  **基本欲望 (Base Desire)**：
    *   机器人的性格设定。话痨设定为 20，高冷设定为 5。
2.  **外部刺激 (External Stimuli)**：
    *   **关键词命中**：群里有人聊到了它记忆库里的关键词（比如“游戏”、“猫”），+30。
    *   **热闹程度**：群消息频率极高（大家聊得很嗨），+10（想凑热闹）。
    *   **冷场时长**：群里安静了 4 小时，+15（想打破尴尬）。
3.  **情绪加成 (Emotion Modifier)**：
    *   调用你的**情绪系统**。
    *   `Arousal` (兴奋度) 高 -> 冲动值大幅增加。
    *   `Pleasure` (愉悦度) 低（抑郁）-> 冲动值降低（不想理人）。
4.  **疲劳值 (Fatigue)**：
    *   刚刚主动发过言 -> 疲劳值拉满（防止连续刷屏）。
    *   随时间线性衰减。

**决策阈值**：
*   当 `Impulse > 80` 时 -> **触发主动发言**。

---

### 二、 三大主动行为模式

根据触发来源不同，将主动行为分为三类：

#### 1. “插话”模式 (The Interrupter)
**场景**：群友 A 和 B 正在聊天，没有 @ 机器人。
**机制**：**旁听 (Eavesdropping)**。

*   **监听队列**：机器人实时分析最近 5 条群消息（即使没 @ 它）。
*   **触发条件**：
    *   检测到**强相关话题**（命中向量数据库的高分记忆）。
    *   检测到**特定的梗**（如“好想死” -> 触发安慰；“笑死” -> 触发复读）。
*   **行为逻辑**：
    *   不要引用某人的话（显得像回复），而是直接扔出一个观点。
    *   *示例*：群友讨论《黑神话：悟空》。机器人检测到关键词，判定自己也是“游戏迷”，Impulse 破表，直接发：“这游戏第三章的那个 BOSS 简直反人类！你们打过去了吗？”

#### 2. “破冰”模式 (The Icebreaker)
**场景**：群里死气沉沉，最后一条消息是 4 小时前。
**机制**：**无聊检测 (Boredom Check)**。

*   **触发条件**：
    *   当前时间是白天（9:00 - 22:00）。
    *   距离上一条消息超过 $X$ 小时。
    *   机器人的 `Mood` 处于正常或兴奋状态。
*   **内容生成策略 (RAG)**：
    *   **考古**：随机抽取一条 1 个月前的群聊记忆摘要。“话说，上次 @老王 说要请客吃饭的事情，是不是不了了之了？”（能够极高效率地炸出潜水员）。
    *   **分享**：从联网热搜/RSS源抓取一条新闻。“你们看到那个新闻了吗……”
    *   **发疯**：纯粹的情绪宣泄。“好想喝奶茶啊啊啊啊！”

#### 3. “生活流”模式 (The Routine)
**场景**：模拟真人的作息时间。
**机制**：**带抖动的定时任务 (Jittered Cron)**。

*   **不要准点**：千万不要设定死“每天 08:00 问好”，那是闹钟。
*   **随机偏移**：设定为 `08:00 + random(-15min, +45min)`。
*   **行为库**：
    *   **早安/晚安**：根据当天天气、星期几（周一很丧，周五很嗨）生成内容。
    *   **午夜网抑云**：凌晨 2 点如果还没睡，发一条“有点失眠，有人在吗？”

---

### 三、 抑制系统：防止变成“烦人的苍蝇”

主动行为必须有**刹车机制**。

1.  **全局冷却 (Global Cooldown)**：
    *   两次“主动发言”之间必须间隔至少 60~120 分钟（可配置）。
    *   但是“被 @ 回复”不受此限制。

2.  **识相机制 (Read the Room)**：
    *   **严肃检测**：如果群聊最近 10 条消息包含“悲伤”、“RIP”、“工作”、“开会”等严肃关键词，强制将 Impulse 锁定为 0。机器人必须闭嘴，绝对不能在别人谈论葬礼时突然插嘴说想喝奶茶。

3.  **深夜模式**：
    *   02:00 - 07:00 期间，将 Impulse 的基础倍率调为 0.1。除非极其特殊的强关键词触发，否则保持安静。

---

### 四、 技术实现流程图 (Pseudo Code)

你需要一个在后台不断运行的 `Event Loop`（事件循环）。

```python
class VolitionSystem:
    def __init__(self):
        self.fatigue = 0
        self.last_active_time = time.now()

    def on_group_message(self, message, group_context):
        """每当群里有人说话（非@机器人）时调用"""
        
        # 1. 严肃检测
        if self.is_serious_topic(group_context):
            return

        # 2. 计算冲动值
        base_desire = 10
        stimulus = self.calculate_stimulus(message) # 关键词匹配、情感分析
        emotion_mod = bot.emotion.arousal * 20      # 情绪越嗨，分越高
        
        current_impulse = (base_desire + stimulus + emotion_mod) - self.fatigue
        
        # 3. 决策
        if current_impulse > 80:
            self.trigger_interruption(message)
            self.add_fatigue(100)
        else:
            # 即使不说话，也要根据消息内容微调情绪
            bot.emotion.update(message)

    def on_timer_tick(self):
        """每分钟运行一次"""
        
        # 1. 疲劳自然衰减
        if self.fatigue > 0:
            self.fatigue -= 5
            
        # 2. 破冰检测
        silence_duration = time.now() - group.last_message_time
        if silence_duration > 4_hours and is_daytime():
            if random.random() < 0.05: # 5%概率，避免每次必发
                self.trigger_icebreaker()
```

---

### 五、 进阶玩法：赋予“意图”

让机器人的主动行为带有**目的性**，而不仅仅是随机说话。

**Intent-Driven Proactivity (意图驱动的主动性)**

在**记忆系统**中维护一个 `TodoList`（愿望清单）：
*   *例子*：机器人今天“想看某个电影”。

1.  **埋线**：早上 10 点，它主动发：“听说《沙丘2》上了，好想看。”
2.  **等待**：如果没有人接话，它会把这个意图挂起。
3.  **再次尝试**：下午 3 点，群里有人聊到“周末去哪”，机器人检测到相关性，立刻提取 `TodoList` 插嘴：“周末去看《沙丘2》怎么样！我早上就想说了！”

**这种跨时间段的意图一致性，会让用户觉得它真的“一直把这件事放在心上”。**

### 总结
设计主动行为系统，本质是在写一个**“抢麦”算法**。
*   **低级的主动**：定时发早报。
*   **中级的主动**：没人说话时讲冷笑话。
*   **高级的主动**：**一直在听**，遇到感兴趣的话题忍不住插嘴，遇到尴尬的冷场懂的救场，且知道什么时候该闭嘴。